name: Check for broken links

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0" # Run weekly on Sundays

permissions:
  contents: read

jobs:
  check-links:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4
      
      - name: Setup Ruby ðŸ’Ž
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3.5"
          bundler-cache: true
      
      - name: Setup Python ðŸ
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
      
      - name: Install dependencies ðŸ”§
        run: |
          sudo apt-get update && sudo apt-get install -y imagemagick
          pip3 install --upgrade nbconvert
      
      - name: Build Jekyll site ðŸ—ï¸
        run: |
          export JEKYLL_ENV=production
          bundle exec jekyll build
      
      - name: Check links with Lychee ðŸ”
        uses: lycheeverse/lychee-action@v2.1.0
        with:
          # Check the built HTML files, not the source
          args: >-
            --verbose
            --no-progress
            --accept 200,201,202,203,204,300,301,302,303,304,305,306,307,308,429
            --exclude-mail
            --exclude-path "./_site/blog/archive/**"
            --exclude-path "./_site/blog/tag/**"
            --exclude-path "./_site/blog/category/**"
            './_site/**/*.html'
          
          # Fail the action on broken links
          fail: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Issue on Failure ðŸ“
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ðŸ”— Broken links detected';
            const body = `Broken links were detected during the scheduled link check.
            
            Please review the [workflow run logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.
            
            This issue was automatically created by the broken-links workflow.`;
            
            // Check if an issue with this title already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['broken-links']
            });
            
            const existingIssue = issues.data.find(issue => issue.title === title);
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['broken-links', 'automated']
              });
            }